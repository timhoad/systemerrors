<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Can You Handle The Truth?</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=OCR+A+Std&display=swap"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        background: #000;
        font-family: 'OCR A Std', monospace;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
      }
      /* Riddle box remains unchanged (original desktop dimensions) */
      .crt {
        background: repeating-linear-gradient(
          to bottom,
          #111,
          #111 2px,
          #0d0d0d 4px,
          #111 6px
        );
        border: 2px solid white;
        border-radius: 12px;
        padding: 20px;
        color: white;
        font-size: 0.8rem;
        width: 60vw;
        max-width: 600px;
        margin-top: 30px;
        margin-bottom: 60px;
        position: relative;
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        text-align: center;
        box-sizing: border-box;
      }
      .cursor {
        display: inline-block;
        width: 10px;
        height: 1em;
        background-color: white;
        animation: blink 0.7s infinite;
        vertical-align: bottom;
      }
      @keyframes blink {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0;
        }
      }
      .letters-container {
        position: relative;
        width: 60vw;
        max-width: 600px;
        height: 30vh;
        margin-bottom: 10px;
        display: none;
      }
      .draggable-letter {
        position: absolute;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
        cursor: grab;
        animation: pulse 3s infinite ease-in-out;
        user-select: none;
        touch-action: none;
      }
      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
          opacity: 0.8;
        }
        50% {
          transform: scale(1.1);
          opacity: 1;
        }
      }
      @keyframes glitch {
        0% { transform: translate(1px, 0); opacity: 1; }
        20% { transform: translate(-1px, 0); opacity: 0.7; }
        40% { transform: translate(1px, 0); opacity: 1; }
        60% { transform: translate(-1px, 0); opacity: 0.7; }
        80% { transform: translate(1px, 0); opacity: 1; }
        100% { transform: translate(0, 0); opacity: 1; }
      }
      .drop-zone {
        display: none;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 20px;
        flex-shrink: 0;
      }
      .drop-row {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px;
      }
      .drop-slot {
        width: 20px;
        height: 24px;
        border-bottom: 2px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
        color: white;
      }
      .drop-slot.filled {
        border-bottom: none;
      }
      .completion-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: black;
        color: white;
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 9999;
      }
      .completion-message {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
        white-space: pre-wrap;
        margin-top: -5cm;
      }
      .completion-cursor {
        display: inline-block;
        width: 10px;
        height: 1em;
        background-color: white;
        animation: blink 0.7s infinite;
        vertical-align: bottom;
      }
      /* Mobile-only styles and modifications */
      @media (max-width: 768px) {
        .letters-container {
          width: 90vw;
          height: 40vh; /* More vertical space for letters */
        }
        .draggable-letter {
          font-size: 1.5rem; /* Larger letters on mobile */
        }
        .drop-slot {
          width: 24px;
          height: 32px;
          font-size: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="crt" id="riddle-box">
      <div id="riddle-text"></div>
      <span class="cursor" id="riddle-cursor"></span>
    </div>
    <div class="letters-container" id="letters-container"></div>
    <div class="drop-zone" id="drop-zone"></div>
    <div class="completion-overlay" id="completion-overlay">
      <div class="completion-message" id="final-message"></div>
      <span class="completion-cursor"></span>
    </div>
    <script>
      // Determine mobile mode based on viewport width.
      const isMobile = window.innerWidth < 768;
      
      // Expected phrase remains "CAN YOU HANDLE THE TRUTH?" in both modes.
      const expectedPhrase = "CAN YOU HANDLE THE TRUTH?";
      const cleanPhrase = expectedPhrase.replace(/\s/g, "");
      
      // Typewriter effect for riddle text (unchanged)
      const riddle = `They built a house on shifting sand,
Then sold the myth with sleight of hand.
Truth trades hands behind closed doors,
Sanitized for distant shores.
The loudest claim "It’s all just fine",
While cracks appear in every line.
Eyes wide shut, we seek the key,
Solve the puzzle and begin to see.`;
      
      const riddleText = document.getElementById("riddle-text");
      const riddleCursor = document.getElementById("riddle-cursor");
      let riddleIndex = 0;
      function typeRiddle() {
        if (riddleIndex < riddle.length) {
          riddleText.innerHTML +=
            riddle[riddleIndex] === "\n" ? "<br>" : riddle[riddleIndex];
          riddleIndex++;
          setTimeout(typeRiddle, 40);
        } else {
          setTimeout(showPuzzle, 300);
        }
      }
      typeRiddle();
      
      // Function to add drop slots in a row based on provided text.
      function addSlots(row, text) {
        for (const char of text) {
          if (char === " ") {
            const spacer = document.createElement("div");
            spacer.style.width = "15px";
            row.appendChild(spacer);
          } else {
            const slot = document.createElement("div");
            slot.classList.add("drop-slot");
            row.appendChild(slot);
          }
        }
      }
      
      // Initialize the drop zones.
      function initializeDropZones() {
        const dropZone = document.getElementById("drop-zone");
        dropZone.innerHTML = "";
        if (isMobile) {
          // For mobile: three rows with "CAN YOU", "HANDLE", "THE TRUTH?"
          for (let i = 1; i <= 3; i++) {
            const row = document.createElement("div");
            row.classList.add("drop-row");
            row.id = "row" + i;
            dropZone.appendChild(row);
          }
          addSlots(document.getElementById("row1"), "CAN YOU");
          addSlots(document.getElementById("row2"), "HANDLE");
          addSlots(document.getElementById("row3"), "THE TRUTH?");
        } else {
          // Desktop: two rows as before.
          for (let i = 1; i <= 2; i++) {
            const row = document.createElement("div");
            row.classList.add("drop-row");
            row.id = "row" + i;
            dropZone.appendChild(row);
          }
          addSlots(document.getElementById("row1"), "CAN YOU HANDLE");
          addSlots(document.getElementById("row2"), "THE TRUTH?");
        }
      }
      
      function showPuzzle() {
        document.getElementById("letters-container").style.display = "block";
        initializeDropZones();
      }
      
      // Generate randomized letters array
      const lettersArray = cleanPhrase.split("").sort(() => Math.random() - 0.5);
      
      // Display draggable letters
      const container = document.getElementById("letters-container");
      let correctCount = 0;
      const letterPositions = [];
      function getRandomPosition() {
        let position;
        let isOverlap = true;
        while (isOverlap) {
          position = {
            x: Math.random() * 90,
            y: Math.random() * 90,
          };
          isOverlap = letterPositions.some(
            p => Math.abs(p.x - position.x) < 10 && Math.abs(p.y - position.y) < 10
          );
        }
        letterPositions.push(position);
        return position;
      }
      
      // Pointer events for drag & drop (common to mobile and desktop)
      let currentLetter = null;
      let pointerOffsetX = 0, pointerOffsetY = 0;
      const slots = () => document.querySelectorAll(".drop-slot");
      
      function onPointerDown(event) {
        currentLetter = event.target;
        if (!currentLetter.dataset.origLeft) {
          currentLetter.dataset.origLeft = currentLetter.style.left;
          currentLetter.dataset.origTop = currentLetter.style.top;
        }
        currentLetter.setPointerCapture(event.pointerId);
        const letterRect = currentLetter.getBoundingClientRect();
        pointerOffsetX = event.clientX - letterRect.left;
        pointerOffsetY = event.clientY - letterRect.top;
        currentLetter.style.zIndex = 1000;
        currentLetter.addEventListener("pointermove", onPointerMove);
        currentLetter.addEventListener("pointerup", onPointerUp);
        currentLetter.addEventListener("pointercancel", onPointerUp);
      }
      
      function onPointerMove(event) {
        if (!currentLetter) return;
        const containerRect = container.getBoundingClientRect();
        let newLeft = event.clientX - containerRect.left - pointerOffsetX;
        let newTop = event.clientY - containerRect.top - pointerOffsetY;
        currentLetter.style.left = `${newLeft}px`;
        currentLetter.style.top = `${newTop}px`;
      }
      
      function onPointerUp(event) {
        if (!currentLetter) return;
        const letterRect = currentLetter.getBoundingClientRect();
        const letterCenterX = letterRect.left + letterRect.width / 2;
        const letterCenterY = letterRect.top + letterRect.height / 2;
        let dropped = false;
        slots().forEach((slot, index) => {
          const slotRect = slot.getBoundingClientRect();
          if (
            letterCenterX >= slotRect.left &&
            letterCenterX <= slotRect.right &&
            letterCenterY >= slotRect.top &&
            letterCenterY <= slotRect.bottom &&
            !slot.classList.contains("filled")
          ) {
            const correctChar = cleanPhrase[index];
            if (currentLetter.textContent === correctChar) {
              slot.textContent = currentLetter.textContent;
              slot.classList.add("filled");
              slot.style.animation = "glitch 0.3s ease-out";
              setTimeout(() => { slot.style.animation = ""; }, 300);
              currentLetter.style.display = "none";
              correctCount++;
              dropped = true;
            }
          }
        });
        if (!dropped) {
          currentLetter.style.left = currentLetter.dataset.origLeft;
          currentLetter.style.top = currentLetter.dataset.origTop;
        }
        currentLetter.style.zIndex = "";
        currentLetter.removeEventListener("pointermove", onPointerMove);
        currentLetter.removeEventListener("pointerup", onPointerUp);
        currentLetter.removeEventListener("pointercancel", onPointerUp);
        currentLetter = null;
        if (correctCount === cleanPhrase.length) {
          setTimeout(() => {
            document.getElementById("completion-overlay").style.display = "flex";
            const finalMsg = document.getElementById("final-message");
            const text = "you persevered, where most don’t even try...";
            let idx = 0;
            function typeFinal() {
              if (idx < text.length) {
                finalMsg.textContent += text[idx];
                idx++;
                setTimeout(typeFinal, 70);
              }
            }
            setTimeout(typeFinal, 500);
          }, 500);
        }
      }
      
      lettersArray.forEach((char, i) => {
        const letter = document.createElement("div");
        letter.classList.add("draggable-letter");
        letter.textContent = char;
        letter.dataset.index = i;
        const { x, y } = getRandomPosition();
        letter.style.left = `${x}%`;
        letter.style.top = `${y}%`;
        container.appendChild(letter);
        letter.addEventListener("pointerdown", onPointerDown);
      });
      
      // Audio setup using Web Audio API to boost volume.
      const audio = new Audio("https://archive.org/download/rumbling/rumbling.mp3");
      audio.loop = true;
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      const audioContext = new AudioContext();
      const gainNode = audioContext.createGain();
      // Amplify audio; adjust gain value if needed.
      gainNode.gain.value = 3.0;
      const track = audioContext.createMediaElementSource(audio);
      track.connect(gainNode).connect(audioContext.destination);
      
      function startAudio() {
        if (audioContext.state === "suspended") {
          audioContext.resume();
        }
        audio.play().catch(err => {
          console.warn("Autoplay blocked:", err);
        });
        window.removeEventListener("click", startAudio);
        window.removeEventListener("touchstart", startAudio);
      }
      window.addEventListener("click", startAudio);
      window.addEventListener("touchstart", startAudio);
    </script>
  </body>
</html>